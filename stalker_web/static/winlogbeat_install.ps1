#Requires -RunAsAdministrator

Write-Host "Downloading Winlogbeat..."
(New-Object System.Net.WebClient).DownloadFile("https://artifacts.elastic.co/downloads/beats/winlogbeat/winlogbeat-7.13.2-windows-x86_64.zip", "winlogbeat.zip")

Write-Host "Extracting files..."
Expand-Archive winlogbeat.zip -DestinationPath winlogbeat

Write-Host "Moving files..."
Move-Item -Path winlogbeat\winlogbeat-7.13.2-windows-x86_64 -Destination 'C:\Program Files\Winlogbeat' -force

Write-Host "Cleaning up..."
Remove-Item -LiteralPath "winlogbeat" -Force -Recurse
Remove-Item winlogbeat.zip

CD 'C:\Program Files\Winlogbeat'

$es_host = Read-Host 'Enter the hostname/IP and port for Elasticsearch (192.168.1.24:9200)'

Write-Host "Replacing config..."
$b64 = 'IyMjIyMjIyMjIyMjIyMjIyMjIyMjIyBXaW5sb2diZWF0IENvbmZpZ3VyYXRpb24gRXhhbXBsZSAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKCiMgVGhpcyBmaWxlIGlzIGFuIGV4YW1wbGUgY29uZmlndXJhdGlvbiBmaWxlIGhpZ2hsaWdodGluZyBvbmx5IHRoZSBtb3N0IGNvbW1vbgojIG9wdGlvbnMuIFRoZSB3aW5sb2diZWF0LnJlZmVyZW5jZS55bWwgZmlsZSBmcm9tIHRoZSBzYW1lIGRpcmVjdG9yeSBjb250YWlucwojIGFsbCB0aGUgc3VwcG9ydGVkIG9wdGlvbnMgd2l0aCBtb3JlIGNvbW1lbnRzLiBZb3UgY2FuIHVzZSBpdCBhcyBhIHJlZmVyZW5jZS4KIwojIFlvdSBjYW4gZmluZCB0aGUgZnVsbCBjb25maWd1cmF0aW9uIHJlZmVyZW5jZSBoZXJlOgojIGh0dHBzOi8vd3d3LmVsYXN0aWMuY28vZ3VpZGUvZW4vYmVhdHMvd2lubG9nYmVhdC9pbmRleC5odG1sCgojID09PT09PT09PT09PT09PT09PT09PT09PSBXaW5sb2diZWF0IHNwZWNpZmljIG9wdGlvbnMgPT09PT09PT09PT09PT09PT09PT09PT09PQoKIyBldmVudF9sb2dzIHNwZWNpZmllcyBhIGxpc3Qgb2YgZXZlbnQgbG9ncyB0byBtb25pdG9yIGFzIHdlbGwgYXMgYW55CiMgYWNjb21wYW55aW5nIG9wdGlvbnMuIFRoZSBZQU1MIGRhdGEgdHlwZSBvZiBldmVudF9sb2dzIGlzIGEgbGlzdCBvZgojIGRpY3Rpb25hcmllcy4KIwojIFRoZSBzdXBwb3J0ZWQga2V5cyBhcmUgbmFtZSAocmVxdWlyZWQpLCB0YWdzLCBmaWVsZHMsIGZpZWxkc191bmRlcl9yb290LAojIGZvcndhcmRlZCwgaWdub3JlX29sZGVyLCBsZXZlbCwgZXZlbnRfaWQsIHByb3ZpZGVyLCBhbmQgaW5jbHVkZV94bWwuIFBsZWFzZQojIHZpc2l0IHRoZSBkb2N1bWVudGF0aW9uIGZvciB0aGUgY29tcGxldGUgZGV0YWlscyBvZiBlYWNoIG9wdGlvbi4KIyBodHRwczovL2dvLmVzLmlvL1dpbmxvZ2JlYXRDb25maWcKCndpbmxvZ2JlYXQuZXZlbnRfbG9nczoKICAtIG5hbWU6IE1pY3Jvc29mdC1XaW5kb3dzLVN5c21vbi9PcGVyYXRpb25hbAogICAgaWdub3JlX29sZGVyOiAyNGgKICAgIHByb2Nlc3NvcnM6CiAgICAgIC0gc2NyaXB0OgogICAgICAgICAgbGFuZzogamF2YXNjcmlwdAogICAgICAgICAgaWQ6IHN5c21vbgogICAgICAgICAgZmlsZTogJHtwYXRoLmhvbWV9L21vZHVsZS9zeXNtb24vY29uZmlnL3dpbmxvZ2JlYXQtc3lzbW9uLmpzCgojID09PT09PT09PT09PT09PT09PT09PT0gRWxhc3RpY3NlYXJjaCB0ZW1wbGF0ZSBzZXR0aW5ncyA9PT09PT09PT09PT09PT09PT09PT09PQoKc2V0dXAudGVtcGxhdGUuc2V0dGluZ3M6CiAgaW5kZXgubnVtYmVyX29mX3NoYXJkczogMQogICNpbmRleC5jb2RlYzogYmVzdF9jb21wcmVzc2lvbgogICNfc291cmNlLmVuYWJsZWQ6IGZhbHNlCgoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IEdlbmVyYWwgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KCiMgVGhlIG5hbWUgb2YgdGhlIHNoaXBwZXIgdGhhdCBwdWJsaXNoZXMgdGhlIG5ldHdvcmsgZGF0YS4gSXQgY2FuIGJlIHVzZWQgdG8gZ3JvdXAKIyBhbGwgdGhlIHRyYW5zYWN0aW9ucyBzZW50IGJ5IGEgc2luZ2xlIHNoaXBwZXIgaW4gdGhlIHdlYiBpbnRlcmZhY2UuCiNuYW1lOgoKIyBUaGUgdGFncyBvZiB0aGUgc2hpcHBlciBhcmUgaW5jbHVkZWQgaW4gdGhlaXIgb3duIGZpZWxkIHdpdGggZWFjaAojIHRyYW5zYWN0aW9uIHB1Ymxpc2hlZC4KI3RhZ3M6IFsic2VydmljZS1YIiwgIndlYi10aWVyIl0KCiMgT3B0aW9uYWwgZmllbGRzIHRoYXQgeW91IGNhbiBzcGVjaWZ5IHRvIGFkZCBhZGRpdGlvbmFsIGluZm9ybWF0aW9uIHRvIHRoZQojIG91dHB1dC4KI2ZpZWxkczoKIyAgZW52OiBzdGFnaW5nCgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBEYXNoYm9hcmRzID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQojIFRoZXNlIHNldHRpbmdzIGNvbnRyb2wgbG9hZGluZyB0aGUgc2FtcGxlIGRhc2hib2FyZHMgdG8gdGhlIEtpYmFuYSBpbmRleC4gTG9hZGluZwojIHRoZSBkYXNoYm9hcmRzIGlzIGRpc2FibGVkIGJ5IGRlZmF1bHQgYW5kIGNhbiBiZSBlbmFibGVkIGVpdGhlciBieSBzZXR0aW5nIHRoZQojIG9wdGlvbnMgaGVyZSBvciBieSB1c2luZyB0aGUgYHNldHVwYCBjb21tYW5kLgojc2V0dXAuZGFzaGJvYXJkcy5lbmFibGVkOiBmYWxzZQoKIyBUaGUgVVJMIGZyb20gd2hlcmUgdG8gZG93bmxvYWQgdGhlIGRhc2hib2FyZHMgYXJjaGl2ZS4gQnkgZGVmYXVsdCB0aGlzIFVSTAojIGhhcyBhIHZhbHVlIHdoaWNoIGlzIGNvbXB1dGVkIGJhc2VkIG9uIHRoZSBCZWF0IG5hbWUgYW5kIHZlcnNpb24uIEZvciByZWxlYXNlZAojIHZlcnNpb25zLCB0aGlzIFVSTCBwb2ludHMgdG8gdGhlIGRhc2hib2FyZCBhcmNoaXZlIG9uIHRoZSBhcnRpZmFjdHMuZWxhc3RpYy5jbwojIHdlYnNpdGUuCiNzZXR1cC5kYXNoYm9hcmRzLnVybDoKCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gS2liYW5hID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgojIFN0YXJ0aW5nIHdpdGggQmVhdHMgdmVyc2lvbiA2LjAuMCwgdGhlIGRhc2hib2FyZHMgYXJlIGxvYWRlZCB2aWEgdGhlIEtpYmFuYSBBUEkuCiMgVGhpcyByZXF1aXJlcyBhIEtpYmFuYSBlbmRwb2ludCBjb25maWd1cmF0aW9uLgojc2V0dXAua2liYW5hOgoKICAjIEtpYmFuYSBIb3N0CiAgIyBTY2hlbWUgYW5kIHBvcnQgY2FuIGJlIGxlZnQgb3V0IGFuZCB3aWxsIGJlIHNldCB0byB0aGUgZGVmYXVsdCAoaHR0cCBhbmQgNTYwMSkKICAjIEluIGNhc2UgeW91IHNwZWNpZnkgYW5kIGFkZGl0aW9uYWwgcGF0aCwgdGhlIHNjaGVtZSBpcyByZXF1aXJlZDogaHR0cDovL2xvY2FsaG9zdDo1NjAxL3BhdGgKICAjIElQdjYgYWRkcmVzc2VzIHNob3VsZCBhbHdheXMgYmUgZGVmaW5lZCBhczogaHR0cHM6Ly9bMjAwMTpkYjg6OjFdOjU2MDEKICAjaG9zdDogImxvY2FsaG9zdDo1NjAxIgoKICAjIEtpYmFuYSBTcGFjZSBJRAogICMgSUQgb2YgdGhlIEtpYmFuYSBTcGFjZSBpbnRvIHdoaWNoIHRoZSBkYXNoYm9hcmRzIHNob3VsZCBiZSBsb2FkZWQuIEJ5IGRlZmF1bHQsCiAgIyB0aGUgRGVmYXVsdCBTcGFjZSB3aWxsIGJlIHVzZWQuCiAgI3NwYWNlLmlkOgoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IEVsYXN0aWMgQ2xvdWQgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KCiMgVGhlc2Ugc2V0dGluZ3Mgc2ltcGxpZnkgdXNpbmcgV2lubG9nYmVhdCB3aXRoIHRoZSBFbGFzdGljIENsb3VkIChodHRwczovL2Nsb3VkLmVsYXN0aWMuY28vKS4KCiMgVGhlIGNsb3VkLmlkIHNldHRpbmcgb3ZlcndyaXRlcyB0aGUgYG91dHB1dC5lbGFzdGljc2VhcmNoLmhvc3RzYCBhbmQKIyBgc2V0dXAua2liYW5hLmhvc3RgIG9wdGlvbnMuCiMgWW91IGNhbiBmaW5kIHRoZSBgY2xvdWQuaWRgIGluIHRoZSBFbGFzdGljIENsb3VkIHdlYiBVSS4KI2Nsb3VkLmlkOgoKIyBUaGUgY2xvdWQuYXV0aCBzZXR0aW5nIG92ZXJ3cml0ZXMgdGhlIGBvdXRwdXQuZWxhc3RpY3NlYXJjaC51c2VybmFtZWAgYW5kCiMgYG91dHB1dC5lbGFzdGljc2VhcmNoLnBhc3N3b3JkYCBzZXR0aW5ncy4gVGhlIGZvcm1hdCBpcyBgPHVzZXI+OjxwYXNzPmAuCiNjbG91ZC5hdXRoOgoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IE91dHB1dHMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KCiMgQ29uZmlndXJlIHdoYXQgb3V0cHV0IHRvIHVzZSB3aGVuIHNlbmRpbmcgdGhlIGRhdGEgY29sbGVjdGVkIGJ5IHRoZSBiZWF0LgoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIEVsYXN0aWNzZWFyY2ggT3V0cHV0IC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0Kb3V0cHV0LmVsYXN0aWNzZWFyY2g6CiAgIyBBcnJheSBvZiBob3N0cyB0byBjb25uZWN0IHRvLgogIGhvc3RzOiBbIkVTX0hPU1RfUkVQTEFDRSJdCgogICMgUHJvdG9jb2wgLSBlaXRoZXIgYGh0dHBgIChkZWZhdWx0KSBvciBgaHR0cHNgLgogICNwcm90b2NvbDogImh0dHBzIgoKICAjIEF1dGhlbnRpY2F0aW9uIGNyZWRlbnRpYWxzIC0gZWl0aGVyIEFQSSBrZXkgb3IgdXNlcm5hbWUvcGFzc3dvcmQuCiAgI2FwaV9rZXk6ICJpZDphcGlfa2V5IgogIHVzZXJuYW1lOiAid2lubG9nYmVhdF9pbnRlcm5hbCIKICBwYXNzd29yZDogIiR7V0xCX1BBU1N9IgoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gTG9nc3Rhc2ggT3V0cHV0IC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KI291dHB1dC5sb2dzdGFzaDoKICAjIFRoZSBMb2dzdGFzaCBob3N0cwogICNob3N0czogWyJsb2NhbGhvc3Q6NTA0NCJdCgogICMgT3B0aW9uYWwgU1NMLiBCeSBkZWZhdWx0IGlzIG9mZi4KICAjIExpc3Qgb2Ygcm9vdCBjZXJ0aWZpY2F0ZXMgZm9yIEhUVFBTIHNlcnZlciB2ZXJpZmljYXRpb25zCiAgI3NzbC5jZXJ0aWZpY2F0ZV9hdXRob3JpdGllczogWyIvZXRjL3BraS9yb290L2NhLnBlbSJdCgogICMgQ2VydGlmaWNhdGUgZm9yIFNTTCBjbGllbnQgYXV0aGVudGljYXRpb24KICAjc3NsLmNlcnRpZmljYXRlOiAiL2V0Yy9wa2kvY2xpZW50L2NlcnQucGVtIgoKICAjIENsaWVudCBDZXJ0aWZpY2F0ZSBLZXkKICAjc3NsLmtleTogIi9ldGMvcGtpL2NsaWVudC9jZXJ0LmtleSIKCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IFByb2Nlc3NvcnMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CnByb2Nlc3NvcnM6CiAgLSBhZGRfaG9zdF9tZXRhZGF0YToKICAgICAgd2hlbi5ub3QuY29udGFpbnMudGFnczogZm9yd2FyZGVkCiAgLSBhZGRfY2xvdWRfbWV0YWRhdGE6IH4KCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBMb2dnaW5nID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgojIFNldHMgbG9nIGxldmVsLiBUaGUgZGVmYXVsdCBsb2cgbGV2ZWwgaXMgaW5mby4KIyBBdmFpbGFibGUgbG9nIGxldmVscyBhcmU6IGVycm9yLCB3YXJuaW5nLCBpbmZvLCBkZWJ1ZwojbG9nZ2luZy5sZXZlbDogZGVidWcKCiMgQXQgZGVidWcgbGV2ZWwsIHlvdSBjYW4gc2VsZWN0aXZlbHkgZW5hYmxlIGxvZ2dpbmcgb25seSBmb3Igc29tZSBjb21wb25lbnRzLgojIFRvIGVuYWJsZSBhbGwgc2VsZWN0b3JzIHVzZSBbIioiXS4gRXhhbXBsZXMgb2Ygb3RoZXIgc2VsZWN0b3JzIGFyZSAiYmVhdCIsCiMgInB1Ymxpc2hlciIsICJzZXJ2aWNlIi4KI2xvZ2dpbmcuc2VsZWN0b3JzOiBbIioiXQoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBYLVBhY2sgTW9uaXRvcmluZyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBXaW5sb2diZWF0IGNhbiBleHBvcnQgaW50ZXJuYWwgbWV0cmljcyB0byBhIGNlbnRyYWwgRWxhc3RpY3NlYXJjaCBtb25pdG9yaW5nCiMgY2x1c3Rlci4gIFRoaXMgcmVxdWlyZXMgeHBhY2sgbW9uaXRvcmluZyB0byBiZSBlbmFibGVkIGluIEVsYXN0aWNzZWFyY2guICBUaGUKIyByZXBvcnRpbmcgaXMgZGlzYWJsZWQgYnkgZGVmYXVsdC4KCiMgU2V0IHRvIHRydWUgdG8gZW5hYmxlIHRoZSBtb25pdG9yaW5nIHJlcG9ydGVyLgojbW9uaXRvcmluZy5lbmFibGVkOiBmYWxzZQoKIyBTZXRzIHRoZSBVVUlEIG9mIHRoZSBFbGFzdGljc2VhcmNoIGNsdXN0ZXIgdW5kZXIgd2hpY2ggbW9uaXRvcmluZyBkYXRhIGZvciB0aGlzCiMgV2lubG9nYmVhdCBpbnN0YW5jZSB3aWxsIGFwcGVhciBpbiB0aGUgU3RhY2sgTW9uaXRvcmluZyBVSS4gSWYgb3V0cHV0LmVsYXN0aWNzZWFyY2gKIyBpcyBlbmFibGVkLCB0aGUgVVVJRCBpcyBkZXJpdmVkIGZyb20gdGhlIEVsYXN0aWNzZWFyY2ggY2x1c3RlciByZWZlcmVuY2VkIGJ5IG91dHB1dC5lbGFzdGljc2VhcmNoLgojbW9uaXRvcmluZy5jbHVzdGVyX3V1aWQ6CgojIFVuY29tbWVudCB0byBzZW5kIHRoZSBtZXRyaWNzIHRvIEVsYXN0aWNzZWFyY2guIE1vc3Qgc2V0dGluZ3MgZnJvbSB0aGUKIyBFbGFzdGljc2VhcmNoIG91dHB1dCBhcmUgYWNjZXB0ZWQgaGVyZSBhcyB3ZWxsLgojIE5vdGUgdGhhdCB0aGUgc2V0dGluZ3Mgc2hvdWxkIHBvaW50IHRvIHlvdXIgRWxhc3RpY3NlYXJjaCAqbW9uaXRvcmluZyogY2x1c3Rlci4KIyBBbnkgc2V0dGluZyB0aGF0IGlzIG5vdCBzZXQgaXMgYXV0b21hdGljYWxseSBpbmhlcml0ZWQgZnJvbSB0aGUgRWxhc3RpY3NlYXJjaAojIG91dHB1dCBjb25maWd1cmF0aW9uLCBzbyBpZiB5b3UgaGF2ZSB0aGUgRWxhc3RpY3NlYXJjaCBvdXRwdXQgY29uZmlndXJlZCBzdWNoCiMgdGhhdCBpdCBpcyBwb2ludGluZyB0byB5b3VyIEVsYXN0aWNzZWFyY2ggbW9uaXRvcmluZyBjbHVzdGVyLCB5b3UgY2FuIHNpbXBseQojIHVuY29tbWVudCB0aGUgZm9sbG93aW5nIGxpbmUuCiNtb25pdG9yaW5nLmVsYXN0aWNzZWFyY2g6CgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBJbnN0cnVtZW50YXRpb24gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQoKIyBJbnN0cnVtZW50YXRpb24gc3VwcG9ydCBmb3IgdGhlIHdpbmxvZ2JlYXQuCiNpbnN0cnVtZW50YXRpb246CiAgICAjIFNldCB0byB0cnVlIHRvIGVuYWJsZSBpbnN0cnVtZW50YXRpb24gb2Ygd2lubG9nYmVhdC4KICAgICNlbmFibGVkOiBmYWxzZQoKICAgICMgRW52aXJvbm1lbnQgaW4gd2hpY2ggd2lubG9nYmVhdCBpcyBydW5uaW5nIG9uIChlZzogc3RhZ2luZywgcHJvZHVjdGlvbiwgZXRjLikKICAgICNlbnZpcm9ubWVudDogIiIKCiAgICAjIEFQTSBTZXJ2ZXIgaG9zdHMgdG8gcmVwb3J0IGluc3RydW1lbnRhdGlvbiByZXN1bHRzIHRvLgogICAgI2hvc3RzOgogICAgIyAgLSBodHRwOi8vbG9jYWxob3N0OjgyMDAKCiAgICAjIEFQSSBLZXkgZm9yIHRoZSBBUE0gU2VydmVyKHMpLgogICAgIyBJZiBhcGlfa2V5IGlzIHNldCB0aGVuIHNlY3JldF90b2tlbiB3aWxsIGJlIGlnbm9yZWQuCiAgICAjYXBpX2tleToKCiAgICAjIFNlY3JldCB0b2tlbiBmb3IgdGhlIEFQTSBTZXJ2ZXIocykuCiAgICAjc2VjcmV0X3Rva2VuOgoKCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IE1pZ3JhdGlvbiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgojIFRoaXMgYWxsb3dzIHRvIGVuYWJsZSA2LjcgbWlncmF0aW9uIGFsaWFzZXMKI21pZ3JhdGlvbi42X3RvXzcuZW5hYmxlZDogdHJ1ZQoK'
$bytes = [Convert]::FromBase64String($b64)
$conf_str = [System.Text.Encoding]::ASCII.GetString($bytes)
$conf_str.replace('ES_HOST_REPLACE', $es_host) | Set-Content 'winlogbeat.yml'

Write-Host "Installing Winlogbeat..."
PowerShell.exe -ExecutionPolicy UnRestricted -File .\install-service-winlogbeat.ps1

Write-Host "Creating keystore..."
New-Item -ItemType directory -Path 'C:\ProgramData\winlogbeat'
.\winlogbeat.exe keystore create -E keystore.path=C:\ProgramData\winlogbeat\winlogbeat.keystore

Write-Host "Enter password for Winlogbeat user"
.\winlogbeat.exe keystore -E keystore.path=C:\ProgramData\winlogbeat\winlogbeat.keystore add WLB_PASS

Write-Host "Finishing install..."
.\winlogbeat.exe setup -e
Start-Service winlogbeat

Write-Host "Complete"

